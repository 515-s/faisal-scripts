-- LocalScript: يفحص فقط الموديلات المتحركة ويغيّر أي اسم "common" إلى "كومون"
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local task = task

-- إعدادات
local SCAN_INTERVAL = 15     -- إعادة بناء خريطة التواتر كل كم ثانية
local POLL_INTERVAL = 1      -- كيف كثير نتحقق من الحركة (ثانية)
local MOVE_THRESHOLD = 0.1   -- تحرك يعتبر حركة (متر تقريبي)
local MARKER_NAME = "Marker"  -- اسم البارت للماركر/العلامة

-- ===== دوال مساعدة (مأخوذة ومبسطة من السكربت السابق) =====
local function isBasePart(obj) return obj and obj:IsA("BasePart") end

local function findAnyMeshIds(model)
    local ids = {}
    for _,v in ipairs(model:GetDescendants()) do
        if v:IsA("SpecialMesh") or v:IsA("MeshPart") or v:IsA("Mesh") then
            local id = v.MeshId or (v:IsA("MeshPart") and v.MeshId) or v.MeshId
            if id and id ~= "" then ids[id] = true end
        end
    end
    local list = {}
    for k,_ in pairs(ids) do table.insert(list, k) end
    return list
end

local function countDecalsAndTextures(model)
    local c = 0
    for _,v in ipairs(model:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then c = c + 1 end
    end
    return c
end

local function countSpecialMaterials(model)
    local c = 0
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            if v.Material == Enum.Material.Neon or v.Material == Enum.Material.ForceField then
                c = c + 1
            end
        end
    end
    return c
end

local function hasGoldishColor(model)
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            local r,g,b = v.Color.R, v.Color.G, v.Color.B
            if r > 0.85 and g > 0.6 and b < 0.4 then
                return true
            end
        end
    end
    return false
end

local function primaryPartOrAny(model)
    if model.PrimaryPart then return model.PrimaryPart end
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then return v end
    end
    return nil
end

local function sizeAndComplexity(model)
    local parts, volume = 0, 0
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            parts = parts + 1
            local s = v.Size
            volume = volume + (s.X * s.Y * s.Z)
        end
    end
    return parts, volume
end

local function nameScore(name)
    local n = tostring(name):lower()
    local score = 0
    if n:find("gold") or n:find("ذهبي") then score = score + 1 end
    if n:find("rare") or n:find("نادر") then score = score + 1 end
    if n:find("legend") or n:find("epic") or n:find("أسطوري") then score = score + 2 end
    return math.clamp(score / 3, 0, 1)
end

local function buildFingerprint(model)
    local meshIds = findAnyMeshIds(model)
    table.sort(meshIds)
    local parts, volume = sizeAndComplexity(model)
    local key = table.concat(meshIds, "|") .. ":" .. tostring(math.floor(parts)) .. ":" .. tostring(math.floor(volume))
    return key
end

-- أوزان (ممكن تعديل)
local WEIGHTS = {
    uniqueness = 0.35,
    mesh = 0.25,
    decals = 0.10,
    material = 0.15,
    name = 0.15,
}

local function computeRarityScore(model, freqMap, modelsMap)
    local fp = modelsMap[model] or buildFingerprint(model)
    local fcount = freqMap[fp] or 1
    local uniqueness = 1 / fcount

    local meshCount = #findAnyMeshIds(model)
    local meshScore = math.clamp(meshCount / 5, 0, 1)

    local decCount = countDecalsAndTextures(model)
    local decalScore = math.clamp(decCount / 10, 0, 1)

    local specialMatCount = countSpecialMaterials(model)
    local materialScore = math.clamp(specialMatCount / 5, 0, 1)
    if hasGoldishColor(model) then materialScore = math.min(1, materialScore + 0.4) end

    local nscore = nameScore(model.Name)
    local parts, volume = sizeAndComplexity(model)
    local complexityScore = math.clamp(parts / 50, 0, 1)

    local total = 0
    total = total + uniqueness * WEIGHTS.uniqueness
    total = total + meshScore * WEIGHTS.mesh
    total = total + decalScore * WEIGHTS.decals
    total = total + materialScore * WEIGHTS.material
    total = total + nscore * WEIGHTS.name
    total = total + complexityScore * 0.05

    if total > 1 then total = 1 end
    if total < 0 then total = 0 end
    return total
end

local function scoreToLabel(score)
    if score >= 0.9 then return "أسطوري" end
    if score >= 0.6 then return "نادر" end
    if score >= 0.35 then return "غير شائع" end
    return "شائع"
end

-- ===== إدارة الواجهة (عرض التسمية) =====
local function showRarityOnModel(model, labelText)
    local markerPart = nil
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) and v.Name == MARKER_NAME then markerPart = v break end
    end
    local parentPart = markerPart or primaryPartOrAny(model)
    if not parentPart then return end

    local billboard = parentPart:FindFirstChild("RarityLabelGui")
    if not billboard then
        billboard = Instance.new("BillboardGui")
        billboard.Name = "RarityLabelGui"
        billboard.Adornee = parentPart
        billboard.Size = UDim2.new(0,160,0,50)
        billboard.StudsOffset = Vector3.new(0, parentPart.Size.Y/2 + 1.2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = parentPart

        local label = Instance.new("TextLabel")
        label.Name = "RarityLabel"
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.TextScaled = true
        label.Font = Enum.Font.SourceSansBold
        label.Parent = billboard
    end
    local lbl = billboard:FindFirstChild("RarityLabel")
    if lbl then lbl.Text = labelText end
end

-- ===== تغيير أي كائن اسمه "common" إلى "كومون" (كبيرة/صغيرة ما يهم) =====
local function renameCommonsInModel(model)
    for _,v in ipairs(model:GetDescendants()) do
        local ok, name = pcall(function() return v.Name end)
        if ok and tostring(name):lower() == "common" then
            -- نغيّر اسم العنصر نفسه
            v.Name = "كومون"
        end
    end
end

-- ===== بناء خريطة التواتر (كل الموديلات) =====
local function scanWorkspaceForFingerprints()
    local freq = {}
    local modelsMap = {}
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") then
            local fp = buildFingerprint(obj)
            freq[fp] = (freq[fp] or 0) + 1
            modelsMap[obj] = fp
        end
    end
    return freq, modelsMap
end

-- ===== اكتشاف الحركة: نحتفظ بمواقع سابقة ونقيس التغير =====
local lastPositions = {} -- model -> Vector3 (آخر موقع لجزء مرجعي)
local function sampleModelPosition(model)
    local p = primaryPartOrAny(model)
    if not p then return nil end
    return p.Position
end

local function hasMoved(model)
    local last = lastPositions[model]
    local current = sampleModelPosition(model)
    if not current then return false end
    if not last then
        lastPositions[model] = current
        return false
    end
    local dist2 = (current - last).Magnitude
    lastPositions[model] = current
    return dist2 > MOVE_THRESHOLD
end

-- ===== إنشاء Marker لو ما موجود (لا نغيّر لونه) =====
local function ensureMarker(model)
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) and v.Name == MARKER_NAME then return v end
    end
    -- ما موجود، ننشئ واحد بسيط (طول 10)
    local main = primaryPartOrAny(model)
    if not main then return nil end
    local part = Instance.new("Part")
    part.Size = Vector3.new(1,10,1)
    part.Color = Color3.fromRGB(128,128,128)
    part.Material = Enum.Material.Neon
    part.CanCollide = false
    part.Anchored = false
    part.Name = MARKER_NAME
    part.CFrame = main.CFrame * CFrame.new(0,20,0)
    local weld = Instance.new("WeldConstraint")
    weld.Part0 = part
    weld.Part1 = main
    weld.Parent = part
    part.Parent = model
    return part
end

-- ===== العملية الرئيسية =====
local freqMap, modelsMap = scanWorkspaceForFingerprints()

-- دالة تقوم بفحص حركة الموديلات ثم تقييمها عند الحركة
task.spawn(function()
    while true do
        -- كل SCAN_INTERVAL نعيد بناء خريطة التواتر (لأن التكرارات تتغير)
        freqMap, modelsMap = scanWorkspaceForFingerprints()

        -- نمشي على كل الموديلات (بسرعة) لكن نقيّم فقط المتحركة
        for _, model in ipairs(Workspace:GetDescendants()) do
            if model:IsA("Model") then
                -- أولًا: لو في أي عنصر اسمه "common" نغيره إلى "كومون"
                renameCommonsInModel(model)

                -- نتأكد أن عنده جزء مرجعي
                local main = primaryPartOrAny(model)
                if not main then
                    -- نخزن nil ونكمل
                else
                    -- لو تحرّك الموديل منذ آخر فحص نقيّمه
                    if hasMoved(model) then
                        -- نضمن وجود ماركر
                        local marker = ensureMarker(model)
                        -- نحسب ندرته ونظهر النتيجة
                        local score = computeRarityScore(model, freqMap, modelsMap)
                        local label = scoreToLabel(score)
                        showRarityOnModel(model, label)
                    end
                end
            end
        end

        task.wait(SCAN_INTERVAL)
    end
end)

-- نراقب إضافات جديدة بسرعة ونسجّل مواقعها
Workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("Model") then
        -- فور الإضافة نهيئ آخر موقع لو فيه BasePart
        local p = primaryPartOrAny(obj)
        if p then lastPositions[obj] = p.Position end
    elseif isBasePart(obj) and obj.Name == MARKER_NAME then
        -- لو حد أضاف Marker يدويًا نسجيله
    end
end)

-- تنظيف جداول كل فترة (يحذف مراجع الموديلات المحذوفة)
task.spawn(function()
    while true do
        local toremove = {}
        for m,_ in pairs(lastPositions) do
            if not m.Parent then toremove[#toremove+1] = m end
        end
        for _,m in ipairs(toremove) do lastPositions[m] = nil end
        task.wait(60)
    end
end)

-- سكربت يقيّم "ندرہ" الموديلات عن طريق فحص خصائصها (mesh, decals, materials, تكرار البصمة...)
-- ضع هذا كـ LocalScript داخل StarterPlayerScripts

local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local player = game:GetService("Players").LocalPlayer

-- =========== إعدادات قابلة للتعديل ===========
local SCAN_INTERVAL = 10          -- كل كم ثانية نعيد الفحص الكامل (لأداء)
local MARKER_NAME = "Marker"      -- اسم البارت اللي نستخدمه لعرض النتيجة
local SHOW_ON_MARKER = true       -- لو true يعرض التصنيف فوق Marker، لو false نعرضه فوق الـ primary part
local OVERRIDES = {
    --["080274da-7548-4b51-87a7-8f75da758f37"] = "أسطوري", -- مثال: اسم الموديل -> تصنيف ثابت
}

-- وزن الإشارات (عدل لو تبي)
local WEIGHTS = {
    uniqueness = 0.35,
    mesh = 0.25,
    decals = 0.10,
    material = 0.15,
    name = 0.15,
}

-- =========== دوال مساعدة ===========
local function isBasePart(obj) return obj and obj:IsA("BasePart") end

local function findAnyMeshIds(model)
    local ids = {}
    for _,v in ipairs(model:GetDescendants()) do
        if v:IsA("SpecialMesh") or v:IsA("MeshPart") then
            local id = v.MeshId or (v:IsA("MeshPart") and v.MeshId) or ""
            if id ~= "" then ids[id] = true end
        end
        if v:IsA("Mesh") then
            local id = v.MeshId or ""
            if id ~= "" then ids[id] = true end
        end
    end
    local list = {}
    for k,_ in pairs(ids) do table.insert(list, k) end
    return list
end

local function countDecalsAndTextures(model)
    local c = 0
    for _,v in ipairs(model:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then c = c + 1 end
    end
    return c
end

local function countSpecialMaterials(model)
    local c = 0
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            if v.Material == Enum.Material.Neon or v.Material == Enum.Material.ForceField then
                c = c + 1
            end
        end
    end
    return c
end

local function hasGoldishColor(model)
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            local r,g,b = v.Color.R, v.Color.G, v.Color.B
            if r > 0.85 and g > 0.6 and b < 0.4 then
                return true
            end
        end
    end
    return false
end

local function primaryPartOrAny(model)
    local p = model.PrimaryPart
    if p then return p end
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then return v end
    end
    return nil
end

local function sizeAndComplexity(model)
    local parts, volume = 0, 0
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then
            parts = parts + 1
            local s = v.Size
            volume = volume + (s.X * s.Y * s.Z)
        end
    end
    return parts, volume
end

local function nameScore(name)
    local n = name:lower()
    local score = 0
    if n:find("gold") or n:find("ذهبي") then score = score + 1 end
    if n:find("rare") or n:find("نادر") then score = score + 1 end
    if n:find("legend") or n:find("epic") or n:find("أسطوري") then score = score + 2 end
    return math.clamp(score / 3, 0, 1)
end

-- =========== مرحلة المسح لبناء خريطة التواتر ===========
local function buildFingerprint(model)
    -- بصمة بسيطة: مجموعة meshIds + تقريب للحجم + عدد الأجزاء
    local meshIds = findAnyMeshIds(model)
    table.sort(meshIds)
    local parts, volume = sizeAndComplexity(model)
    local key = table.concat(meshIds, "|") .. ":" .. tostring(math.floor(parts)) .. ":" .. tostring(math.floor(volume))
    return key
end

local function scanWorkspaceForFingerprints()
    local freq = {}        -- fingerprint -> count
    local models = {}      -- جدول حفظ المراجع (lists of models per fingerprint)
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") then
            local fp = buildFingerprint(obj)
            freq[fp] = (freq[fp] or 0) + 1
            models[obj] = fp
        end
    end
    return freq, models
end

-- =========== حساب درجة الندرة لكل موديل ===========
local function computeRarityScore(model, freqMap, modelsMap)
    -- override سريع
    local override = OVERRIDES[model.Name]
    if override then
        -- نعطي قيمة عالية لو override = "أسطوري"
        if override == "أسطوري" then return 0.98 end
        if override == "نادر" then return 0.75 end
        if override == "غير شائع" then return 0.5 end
        if override == "شائع" then return 0.2 end
    end

    local fp = modelsMap[model] or buildFingerprint(model)
    local fcount = freqMap[fp] or 1

    -- uniqueness score: 1 - normalize(freq)
    local uniqueness = 1 / fcount -- إذا 1 نسخة => 1.0، إذا 10 نسخ => 0.1

    -- mesh score
    local meshCount = #findAnyMeshIds(model)
    local meshScore = math.clamp(meshCount / 5, 0, 1) -- أكثر من 5 ميشات يعتبر قوي

    -- decals score
    local decCount = countDecalsAndTextures(model)
    local decalScore = math.clamp(decCount / 10, 0, 1)

    -- material/gold score
    local specialMatCount = countSpecialMaterials(model)
    local materialScore = math.clamp(specialMatCount / 5, 0, 1)
    if hasGoldishColor(model) then
        materialScore = math.min(1, materialScore + 0.4)
    end

    -- name hint
    local nscore = nameScore(model.Name)

    -- حجم وتعقيد: جزء بسيط (نموذجية)
    local parts, volume = sizeAndComplexity(model)
    local complexityScore = math.clamp(parts / 50, 0, 1)

    -- اجمع كل الإشارات بالأوزان (عدل WEIGHTS إذا تريد)
    local total = 0
    total = total + uniqueness * WEIGHTS.uniqueness
    total = total + meshScore * WEIGHTS.mesh
    total = total + decalScore * WEIGHTS.decals
    total = total + materialScore * WEIGHTS.material
    total = total + nscore * WEIGHTS.name
    -- نضيف بعض من التعقيد (خفيف)
    total = total + complexityScore * 0.05

    -- نطبع في مجال 0..1
    if total > 1 then total = 1 end
    if total < 0 then total = 0 end
    return total
end

local function scoreToLabel(score)
    if score >= 0.9 then return "أسطوري" end
    if score >= 0.6 then return "نادر" end
    if score >= 0.35 then return "غير شائع" end
    return "شائع"
end

-- =========== عرض النتيجة على الموديل ===========
local function showRarityOnModel(model, labelText)
    -- نضع Billboard على الـ Marker لو موجود، وإلا على الـ primary part
    local markerPart = nil
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) and v.Name == MARKER_NAME then markerPart = v break end
    end
    local parentPart = markerPart or primaryPartOrAny(model)
    if not parentPart then return end

    -- نستخدم نفس دالة العرض البسيطة
    local billboard = parentPart:FindFirstChild("RarityLabelGui")
    if not billboard then
        billboard = Instance.new("BillboardGui")
        billboard.Name = "RarityLabelGui"
        billboard.Adornee = parentPart
        billboard.Size = UDim2.new(0,160,0,50)
        billboard.StudsOffset = Vector3.new(0, parentPart.Size.Y/2 + 1.5, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = parentPart

        local label = Instance.new("TextLabel")
        label.Name = "RarityLabel"
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.TextScaled = true
        label.Font = Enum.Font.SourceSansBold
        label.Parent = billboard
    end
    local lbl = billboard:FindFirstChild("RarityLabel")
    if lbl then lbl.Text = labelText end
end

-- =========== المسح والتقييم الدوري ===========
local function fullScanAndEvaluate()
    local freq, modelsMap = scanWorkspaceForFingerprints()
    for model, fp in pairs(modelsMap) do
        -- compute rarity
        local score = computeRarityScore(model, freq, modelsMap)
        local label = scoreToLabel(score)
        showRarityOnModel(model, label)
    end
end

-- أول فحص سريع عند التشغيل
fullScanAndEvaluate()

-- إعادة التقييم دوريًا (بالحجم اللي تختاره)
task.spawn(function()
    while true do
        task.wait(SCAN_INTERVAL)
        fullScanAndEvaluate()
    end
end)

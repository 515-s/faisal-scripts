-- Faisal Script (نسخة سريعة مع فحص تايمر)
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- حذف أي موديل اسمه "Roter" والحرق لو انضاف بعدين
local function destroyRoter(inst)
	if inst:IsA("Model") and inst.Name == "Roter" then
		pcall(function() inst:Destroy() end)
	end
end
for _, c in pairs(Workspace:GetChildren()) do destroyRoter(c) end
Workspace.ChildAdded:Connect(destroyRoter)

-- الإحداثيات
local points = {
	Vector3.new(-55, -2, -65),
	Vector3.new(-50, 1, -76),
	Vector3.new(-58, 4, -85),
	Vector3.new(-50, 7, -96),
	Vector3.new(-56, 7, -108),
	Vector3.new(-25, 13, -130),
	Vector3.new(0, 25, -105),
	Vector3.new(-10, 31, -92),
	Vector3.new(-3, 31, -87)
}

-- حذف GUI قديم
if player:FindFirstChild("PlayerGui") then
	local old = player.PlayerGui:FindFirstChild("FaisalAutoGift")
	if old then old:Destroy() end
end

-- إنشاء GUI
local gui = Instance.new("ScreenGui")
gui.Name = "FaisalAutoGift"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 220, 0, 110)
frame.Position = UDim2.new(0.5, -110, 0.75, 0)
frame.BackgroundColor3 = Color3.fromRGB(10,10,10)
frame.BorderSizePixel = 0
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.Active = true
frame.Parent = gui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local credit = Instance.new("TextLabel", frame)
credit.Size = UDim2.new(1, -12, 0, 22)
credit.Position = UDim2.new(0,6,0,6)
credit.BackgroundTransparency = 1
credit.Text = "faisal-script"
credit.TextColor3 = Color3.fromRGB(180,180,180)
credit.TextScaled = true
credit.Font = Enum.Font.GothamBold
credit.TextXAlignment = Enum.TextXAlignment.Left

local button = Instance.new("TextButton", frame)
button.Size = UDim2.new(0.9, 0, 0, 56)
button.Position = UDim2.new(0.05, 0, 0, 34)
button.Text = "AUTO FREE GIFT"
button.TextScaled = true
button.Font = Enum.Font.GothamBlack
button.BackgroundColor3 = Color3.fromRGB(0,0,0) -- يبدأ أسود
button.TextColor3 = Color3.fromRGB(255,255,255)
button.Parent = frame
Instance.new("UICorner", button).CornerRadius = UDim.new(0,10)

-- GUI وسط الشاشة لعرض التايمر لو موجود
local centerFrame = Instance.new("Frame", gui)
centerFrame.Size = UDim2.new(0, 300, 0, 70)
centerFrame.Position = UDim2.new(0.5, -150, 0.45, 0)
centerFrame.BackgroundTransparency = 0.2
centerFrame.BackgroundColor3 = Color3.fromRGB(0,0,0)
centerFrame.Visible = false
Instance.new("UICorner", centerFrame).CornerRadius = UDim.new(0,10)

local timerLabel = Instance.new("TextLabel", centerFrame)
timerLabel.Size = UDim2.new(1, -12, 1, -12)
timerLabel.Position = UDim2.new(0,6,0,6)
timerLabel.BackgroundTransparency = 1
timerLabel.Text = ""
timerLabel.TextScaled = true
timerLabel.Font = Enum.Font.GothamBold
timerLabel.TextColor3 = Color3.fromRGB(255,255,255)

-- سحب (drag) بسيط للـ frame
local dragging, dragStart, startPos
frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
frame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		if dragging and dragStart and startPos then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end
end)

-- دوال الحركة (سريعة)
local function getHRP()
	local char = player.Character
	if not char then return nil end
	return char:FindFirstChild("HumanoidRootPart")
end

local function safeTeleport(hrp, pos)
	if not hrp then return end
	local ok, err = pcall(function()
		hrp.CFrame = CFrame.new(pos + Vector3.new(0,2,0))
	end)
	if not ok then
		local char = player.Character
		if char and char.PrimaryPart then
			pcall(function() char:SetPrimaryPartCFrame(CFrame.new(pos + Vector3.new(0,2,0))) end)
		end
	end
end

local function smoothMoveFast(hrp, targetPos)
	if not hrp then return end
	local targetCFrame = CFrame.new(targetPos + Vector3.new(0,2,0))
	local dist = (hrp.Position - targetPos).Magnitude
	-- سرعة أسرع: نقسم على رقم أكبر ليصير أقصر (أسرع)
	local duration = math.clamp(dist/40, 0.25, 2) -- أسرع من قبل
	local tween = TweenService:Create(hrp, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
	tween:Play()
	local finished = false
	tween.Completed:Connect(function() finished = true end)
	local t0 = tick()
	while not finished and tick() - t0 < duration + 0.8 do
		task.wait(0.05)
	end
end

-- الفحص حول اللاعب لمسافة 10 ستد ولمدة 2 ثانية
local function scanForTimerAround(hrp)
	local radius = 10
	local scanDuration = 2
	local scanInterval = 0.12
	local found = nil

	local t0 = tick()
	while tick() - t0 <= scanDuration do
		-- تفحص كل العناصر في الـ Workspace
		for _, inst in pairs(Workspace:GetDescendants()) do
			if inst and inst.Parent then
				local nameLower = tostring(inst.Name):lower()
				if nameLower:find("موقت") or nameLower:find("تايمر") or nameLower:find("timer") then
					-- تأكد مسافة
					local pos
					if inst:IsA("BasePart") then
						pos = inst.Position
					else
						-- لو عنده PrimaryPart أو Position child
						local primary = inst:FindFirstChildWhichIsA("BasePart") or (inst:IsA("Model") and inst.PrimaryPart)
						if primary and primary:IsA("BasePart") then pos = primary.Position end
					end
					if pos and hrp and (hrp.Position - pos).Magnitude <= radius then
						found = inst
						break
					end
				end
			end
		end
		if found then break end
		task.wait(scanInterval)
	end

	return found
end

-- عرض قيمة التايمر ومتابعتها
local function showAndTrackTimer(inst)
	if not inst then return end
	centerFrame.Visible = true
	-- ابحث عن قيمة قابلة للعرض داخل العنصر
	local valueObj
	for _, child in pairs(inst:GetDescendants()) do
		if child:IsA("NumberValue") or child:IsA("IntValue") or child:IsA("StringValue") or child:IsA("BoolValue") then
			valueObj = child
			break
		end
	end

	-- دالة لتحديث النص
	local function updateText()
		local name = inst.Name
		local valText = ""
		if valueObj then
			valText = tostring(valueObj.Value)
		else
			-- محاولة قراءة خاصية Text أو Value أو Attribute إن وجدت
			local ok, out = pcall(function()
				if inst:FindFirstChild("Text") and inst.Text then
					return tostring(inst.Text)
				end
				if inst:GetAttributes and inst:GetAttribute("Value") then
					return tostring(inst:GetAttribute("Value"))
				end
				return "detected"
			end)
			valText = ok and out or "detected"
		end
		timerLabel.Text = name .. "  |  " .. valText
	end

	updateText()

	-- اتصالات للتحديث
	local con1, con2
	if valueObj then
		con1 = valueObj.Changed:Connect(function() updateText() end)
	else
		-- لو ما فيه Value حاول تتبع أي تغيير في الـ instance
		con2 = inst.Changed:Connect(function() updateText() end)
	end

	-- ارجع دالة تعطّل المتابعة لما نحتاج
	return function()
		if con1 and con1.Connected then con1:Disconnect() end
		if con2 and con2.Connected then con2:Disconnect() end
		centerFrame.Visible = false
	end
end

-- تشغيل التسلسل
local running = false
local cleanupTracker = nil

local function runSequence()
	if running then return end
	running = true
	button.BackgroundColor3 = Color3.fromRGB(0,170,0)
	button.Text = "RUNNING..."

	-- تأكد الـ HRP
	local hrp = getHRP()
	if not hrp then
		player.CharacterAdded:Wait()
		hrp = getHRP()
		if not hrp then
			running = false
			button.BackgroundColor3 = Color3.fromRGB(0,0,0)
			button.Text = "AUTO FREE GIFT"
			return
		end
	end

	-- تيليبورت سريع لكل النقاط ما عدا آخر نقطتين، مع تقليل الانتظار
	for i = 1, #points - 1 do
		if not running then break end

		if i == #points - 1 then
			-- وصلنا قبل الأخير بسرعة
			safeTeleport(hrp, points[i])
			task.wait(0.08)
			-- الآن نمشي بسرعة للأخير
			smoothMoveFast(hrp, points[#points])
		else
			safeTeleport(hrp, points[i])
			task.wait(0.08) -- أسرع
		end

		-- لو اللاعب مات أو respawn
		if not player.Character or not getHRP() then
			player.CharacterAdded:Wait()
			hrp = getHRP()
			if not hrp then break end
		end
	end

	-- بعد الوصول للنقطة الأخيرة: نفحص بمحيط 10 ستد لمدة ثانيتين
	if running then
		hrp = getHRP()
		if hrp then
			local found = scanForTimerAround(hrp)
			if found then
				-- عرض ومتابعة
				local stopTrack = showAndTrackTimer(found)
				cleanupTracker = stopTrack
				-- إذا تغيرت القيمة أو اختفى العنصر، نتابع تلقائياً عبر الاتصالات داخل showAndTrackTimer
				-- نترك العرض لحد ما المستخدم يوقفه أو يظهر شرط إنه يختفي تلقائياً بعد 20 ثانية
				spawn(function()
					local tstart = tick()
					while tick() - tstart < 20 and running do
						task.wait(0.25)
					end
					if cleanupTracker then cleanupTracker(); cleanupTracker = nil end
				end)
			end
		end
	end

	-- إنهاء
	running = false
	button.BackgroundColor3 = Color3.fromRGB(0,0,0)
	button.Text = "AUTO FREE GIFT"
end

button.MouseButton1Click:Connect(function()
	if not running then
		-- تأكد شخصية
		if not player.Character or not getHRP() then
			player.CharacterAdded:Wait()
			task.wait(0.2)
		end
		spawn(runSequence)
	end
end)

-- زر إيقاف سريع (اضغط على الـ credit)
credit.InputBegan:Connect(function(inp)
	if inp.UserInputType == Enum.UserInputType.MouseButton1 and running then
		running = false
		if cleanupTracker then cleanupTracker(); cleanupTracker = nil end
		button.BackgroundColor3 = Color3.fromRGB(0,0,0)
		button.Text = "AUTO FREE GIFT"
	end
end)

local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local task = task

local POLL_INTERVAL = 1 -- كل كم ثانية نتحقق من الحركة
local MOVE_THRESHOLD = 0.1
local MARKER_NAME = "Marker"

local lastPositions = {}

local function isBasePart(obj) return obj and obj:IsA("BasePart") end

local function primaryPartOrAny(model)
    if model.PrimaryPart then return model.PrimaryPart end
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) then return v end
    end
    return nil
end

-- تغيير أي "common" إلى "كومون"
local function renameCommonsInModel(model)
    for _,v in ipairs(model:GetDescendants()) do
        if tostring(v.Name):lower() == "common" then
            v.Name = "كومون"
        end
    end
end

local function sampleModelPosition(model)
    local p = primaryPartOrAny(model)
    if not p then return nil end
    return p.Position
end

local function hasMoved(model)
    local last = lastPositions[model]
    local current = sampleModelPosition(model)
    if not current then return false end
    if not last then
        lastPositions[model] = current
        return false
    end
    local dist2 = (current - last).Magnitude
    lastPositions[model] = current
    return dist2 > MOVE_THRESHOLD
end

local function ensureMarker(model)
    for _,v in ipairs(model:GetDescendants()) do
        if isBasePart(v) and v.Name == MARKER_NAME then return v end
    end
    local main = primaryPartOrAny(model)
    if not main then return nil end
    local part = Instance.new("Part")
    part.Size = Vector3.new(1,10,1)
    part.Color = Color3.fromRGB(128,128,128)
    part.Material = Enum.Material.Neon
    part.CanCollide = false
    part.Anchored = false
    part.Name = MARKER_NAME
    part.CFrame = main.CFrame * CFrame.new(0,20,0)
    local weld = Instance.new("WeldConstraint")
    weld.Part0 = part
    weld.Part1 = main
    weld.Parent = part
    part.Parent = model
    return part
end

-- نص فوق الموديل
local function showLabel(model, text)
    local main = primaryPartOrAny(model)
    if not main then return end
    local gui = main:FindFirstChild("RarityLabelGui")
    if not gui then
        gui = Instance.new("BillboardGui")
        gui.Name = "RarityLabelGui"
        gui.Adornee = main
        gui.Size = UDim2.new(0,120,0,40)
        gui.StudsOffset = Vector3.new(0,main.Size.Y/2 + 1.5,0)
        gui.AlwaysOnTop = true
        gui.Parent = main
        local label = Instance.new("TextLabel")
        label.Name = "RarityLabel"
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.fromRGB(255,255,255)
        label.TextScaled = true
        label.Font = Enum.Font.SourceSansBold
        label.Parent = gui
    end
    local label = gui:FindFirstChild("RarityLabel")
    if label then label.Text = text end
end

-- العملية الرئيسية
task.spawn(function()
    while true do
        for _,model in ipairs(Workspace:GetDescendants()) do
            if model:IsA("Model") then
                renameCommonsInModel(model)
                if hasMoved(model) then
                    ensureMarker(model)
                    showLabel(model, "تحرك") -- تقدر تغيّر النص لأي حاجة
                end
            end
        end
        task.wait(POLL_INTERVAL)
    end
end)
